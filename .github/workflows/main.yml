name: Update Build Number and Push via PR

on:
  push:
    branches:
      - '**'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit count
        run: echo "COMMIT_COUNT=$(git rev-list --count HEAD)" >> $GITHUB_ENV

      - name: Update package.json with build number
        run: |
          COMMIT_COUNT=${{ env.COMMIT_COUNT }}
          jq --arg build "$COMMIT_COUNT" '.build = ($build | tonumber)' package.json > temp.json && mv temp.json package.json

      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"
          git checkout -b build-update-${{ env.COMMIT_COUNT }}
          git add package.json
          git commit -m "ðŸ”„ Update build number to ${{ env.COMMIT_COUNT }}"
          git push origin build-update-${{ env.COMMIT_COUNT }}

      - name: Create Pull Request
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.pulls.create({
              owner: 'JangHwanPark',
              repo: 'japark-react-components',
              title: 'ðŸ”„ Update Build Number',
              head: 'build-update-${{ env.COMMIT_COUNT }}',
              base: 'dev',
              body: 'This PR updates the build number automatically.',
              merge_method: 'squash'
            })